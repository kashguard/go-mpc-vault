syntax = "proto3";

package infra.v1;

import "infra/v1/common.proto";

option go_package = "github.com/kashguard/go-mpc-vault/internal/infra/grpc/v1;infra";

// BackupService 备份服务
service BackupService {
  // 恢复MPC分片（从SSS备份分片）
  rpc RecoverMPCShare(RecoverMPCShareRequest) returns (RecoverMPCShareResponse);
  
  // 获取备份状态
  rpc GetBackupStatus(GetBackupStatusRequest) returns (GetBackupStatusResponse);
  
  // 列出备份分片
  rpc ListBackupShares(ListBackupSharesRequest) returns (ListBackupSharesResponse);
}

// BackupDeliveryService 备份分片下发服务
service BackupDeliveryService {
    // 请求分片下发
    rpc RequestShareDelivery(ShareDeliveryRequest) returns (ShareDeliveryResponse);
    // 确认分片接收
    rpc ConfirmShareDelivery(ShareConfirmationRequest) returns (ShareConfirmationResponse);
    // 查询分片状态
    rpc QueryShareStatus(ShareStatusQuery) returns (ShareStatusResponse);
}

// RecoverMPCShareRequest 恢复MPC分片请求
message RecoverMPCShareRequest {
  string key_id = 1;
  string node_id = 2;  // server-proxy-1, server-proxy-2, client-{userID}
  bytes share_data = 3; // Client-provided backup share data (optional)
}

// RecoverMPCShareResponse 恢复MPC分片响应
message RecoverMPCShareResponse {
  string key_id = 1;
  string node_id = 2;
  bool success = 3;
  string message = 4;
}

// GetBackupStatusRequest 获取备份状态请求
message GetBackupStatusRequest {
  string key_id = 1;
}

// GetBackupStatusResponse 获取备份状态响应
message GetBackupStatusResponse {
  string key_id = 1;
  repeated BackupStatus statuses = 2;
}

// ListBackupSharesRequest 列出备份分片请求
message ListBackupSharesRequest {
  string key_id = 1;
  string node_id = 2;  // 可选，如果为空则列出所有节点的备份分片
}

// ListBackupSharesResponse 列出备份分片响应
message ListBackupSharesResponse {
  string key_id = 1;
  map<string, BackupShares> shares_by_node = 2;  // node_id -> BackupShares
}

// BackupStatus 备份状态
message BackupStatus {
  string node_id = 1;
  int32 total_shares = 2;
  int32 required_shares = 3;
  bool recoverable = 4;
}

// BackupShares 备份分片列表
message BackupShares {
  string node_id = 1;
  repeated BackupShare shares = 2;
}

// BackupShare 备份分片
message BackupShare {
  string key_id = 1;
  string node_id = 2;
  int32 share_index = 3;
  string created_at = 4;
}

message ShareDeliveryRequest {
    string client_id = 1; // UserID
    string key_id = 2;
    string node_id = 3;
    int32 share_index = 4;
    bytes client_public_key = 5;  // 客户端公钥 (for encryption)
}

message ShareDeliveryResponse {
    // delivery_id removed as we use composite key
    bytes encrypted_share = 2;
    bytes signature = 3;  // 服务端签名
    int64 timestamp = 4;
}

message ShareConfirmationRequest {
    string client_id = 1; // UserID
    string key_id = 2;
    string node_id = 3;
    int32 share_index = 4;
    bool received_successfully = 5;
    string failure_reason = 6;
}

message ShareConfirmationResponse {
    bool confirmed = 1;
    string message = 2;
}

message ShareStatusQuery {
    string client_id = 1; // UserID
    string key_id = 2;
    string node_id = 3;
    int32 share_index = 4;
}

message ShareStatusResponse {
    string status = 1;
    int64 delivered_at = 2;
    int64 confirmed_at = 3;
    string failure_reason = 4;
}
